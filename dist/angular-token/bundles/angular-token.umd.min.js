!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/router"),require("@angular/common/http"),require("@angular/common"),require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("angular-token",["exports","@angular/core","@angular/router","@angular/common/http","@angular/common","rxjs","rxjs/operators"],e):e((t=t||self)["angular-token"]={},t.ng.core,t.ng.router,t.ng.common.http,t.ng.common,t.rxjs,t.rxjs.operators)}(this,(function(t,e,o,n,r,i,a){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function s(t,e,o,n){var r,i=arguments.length,a=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,o,n);else for(var s=t.length-1;s>=0;s--)(r=t[s])&&(a=(i<3?r(a):i>3?r(e,o,a):r(e,o))||a);return i>3&&a&&Object.defineProperty(e,o,a),a}function u(t,e){return function(o,n){e(o,n,t)}}function l(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}var p=new e.InjectionToken("ANGULAR_TOKEN_OPTIONS"),c=function(){function t(t,e,o,n,a){this.http=t,this.platformId=o,this.activatedRoute=n,this.router=a,this.userType=new i.BehaviorSubject(null),this.authData=new i.BehaviorSubject(null),this.userData=new i.BehaviorSubject(null),this.localStorage={},this.global="undefined"!=typeof window?window:{},r.isPlatformServer(this.platformId)?(this.global={open:function(){return null},location:{href:"/",origin:"/"}},this.localStorage.setItem=function(){return null},this.localStorage.getItem=function(){return null},this.localStorage.removeItem=function(){return null}):this.localStorage=localStorage;var s={apiPath:null,apiBase:null,signInPath:"auth/sign_in",signInRedirect:null,signInStoredUrlStorageKey:null,signOutPath:"auth/sign_out",validateTokenPath:"auth/validate_token",signOutFailedValidate:!1,registerAccountPath:"auth",deleteAccountPath:"auth",registerAccountCallback:this.global.location.href,updatePasswordPath:"auth",resetPasswordPath:"auth/password",resetPasswordCallback:this.global.location.href,userTypes:null,loginField:"email",oAuthBase:this.global.location.origin,oAuthPaths:{github:"auth/github"},oAuthCallbackPath:"oauth_callback",oAuthWindowType:"newWindow",oAuthWindowOptions:null,oAuthBrowserCallbacks:{github:"auth/github/callback"}},u=Object.assign(s,e);this.options=u,null===this.options.apiBase&&console.warn("[angular-token] You have not configured 'apiBase', which may result in security issues. Please refer to the documentation at https://github.com/neroniaky/angular-token/wiki"),this.tryLoadAuthData()}return Object.defineProperty(t.prototype,"currentUserType",{get:function(){return null!=this.userType.value?this.userType.value.name:void 0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentUserData",{get:function(){return this.userData.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentAuthData",{get:function(){return this.authData.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"apiBase",{get:function(){return console.warn("[angular-token] The attribute .apiBase will be removed in the next major release, please use.tokenOptions.apiBase instead"),this.options.apiBase},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tokenOptions",{get:function(){return this.options},set:function(t){this.options=Object.assign(this.options,t)},enumerable:!0,configurable:!0}),t.prototype.userSignedIn=function(){return null!=this.authData.value},t.prototype.canActivate=function(t,e){return!!this.userSignedIn()||(this.options.signInStoredUrlStorageKey&&this.localStorage.setItem(this.options.signInStoredUrlStorageKey,e.url),this.router&&this.options.signInRedirect&&this.router.navigate([this.options.signInRedirect]),!1)},t.prototype.registerAccount=function(t,e){null==(t=Object.assign({},t)).userType?this.userType.next(null):(this.userType.next(this.getUserTypeByName(t.userType)),delete t.userType),null==t.password_confirmation&&null!=t.passwordConfirmation&&(t.password_confirmation=t.passwordConfirmation,delete t.passwordConfirmation),void 0!==e&&(t.additionalData=e);var o=t.login;return delete t.login,t[this.options.loginField]=o,t.confirm_success_url=this.options.registerAccountCallback,this.http.post(this.getServerPath()+this.options.registerAccountPath,t)},t.prototype.deleteAccount=function(){return this.http.delete(this.getServerPath()+this.options.deleteAccountPath)},t.prototype.signIn=function(t,e){var o,n=this;this.userType.next(null==t.userType?null:this.getUserTypeByName(t.userType));var r=((o={})[this.options.loginField]=t.login,o.password=t.password,o);void 0!==e&&(r.additionalData=e);var i=this.http.post(this.getServerPath()+this.options.signInPath,r).pipe(a.share());return i.subscribe((function(t){return n.userData.next(t.data)})),i},t.prototype.signInOAuth=function(t,e,o){var n=this,r=this.getOAuthPath(t),a=this.global.location.origin+"/"+this.options.oAuthCallbackPath,s=this.options.oAuthWindowType,u=this.getOAuthUrl(r,a,s);if("newWindow"!==s&&("inAppBrowser"!=s||o&&o.is("cordova")&&(o.is("ios")||o.is("android")))){if("inAppBrowser"==s){var l=this.options.oAuthBrowserCallbacks[t];if(!l)throw new Error("To login with oAuth provider "+t+" using inAppBrowser the callback (in oAuthBrowserCallbacks) is required.");var p=e.create(u,"_blank","location=no");return new i.Observable((function(t){p.on("loadstop").subscribe((function(e){e.url.indexOf(l)>-1&&p.executeScript({code:"requestCredentials();"}).then((function(e){n.getAuthDataFromPostMessage(e[0]);var o=i.interval(400).subscribe((function(){n.userSignedIn()&&(t.next(n.authData),t.complete(),o.unsubscribe(),p.close())}),(function(e){t.error(e),t.complete()}))}),(function(e){t.error(e),t.complete()}))}),(function(e){t.error(e),t.complete()}))}))}if("sameWindow"===s)return void(this.global.location.href=u);throw new Error('Unsupported oAuthWindowType "'+s+'"')}var c=this.options.oAuthWindowOptions,h="";if(c)for(var d in c)c.hasOwnProperty(d)&&(h+=","+d+"="+c[d]);var g=window.open(u,"_blank","closebuttoncaption=Cancel"+h);return this.requestCredentialsViaPostMessage(g)},t.prototype.processOAuthCallback=function(){this.getAuthDataFromParams()},t.prototype.signOut=function(){var t=this;return this.http.delete(this.getServerPath()+this.options.signOutPath).pipe(a.finalize((function(){t.localStorage.removeItem("accessToken"),t.localStorage.removeItem("client"),t.localStorage.removeItem("expiry"),t.localStorage.removeItem("tokenType"),t.localStorage.removeItem("uid"),t.authData.next(null),t.userType.next(null),t.userData.next(null)})))},t.prototype.validateToken=function(){var t=this,e=this.http.get(this.getServerPath()+this.options.validateTokenPath).pipe(a.share());return e.subscribe((function(e){return t.userData.next(e.data)}),(function(e){401===e.status&&t.options.signOutFailedValidate&&t.signOut()})),e},t.prototype.updatePassword=function(t){var e;null!=t.userType&&this.userType.next(this.getUserTypeByName(t.userType)),e=null==t.passwordCurrent?{password:t.password,password_confirmation:t.passwordConfirmation}:{current_password:t.passwordCurrent,password:t.password,password_confirmation:t.passwordConfirmation},t.resetPasswordToken&&(e.reset_password_token=t.resetPasswordToken);var o=e;return this.http.put(this.getServerPath()+this.options.updatePasswordPath,o)},t.prototype.resetPassword=function(t,e){var o;void 0!==e&&(t.additionalData=e),this.userType.next(null==t.userType?null:this.getUserTypeByName(t.userType));var n=((o={})[this.options.loginField]=t.login,o.redirect_url=this.options.resetPasswordCallback,o);return this.http.post(this.getServerPath()+this.options.resetPasswordPath,n)},t.prototype.getUserPath=function(){return null==this.userType.value?"":this.userType.value.path+"/"},t.prototype.getApiPath=function(){var t="";return null!=this.options.apiBase&&(t+=this.options.apiBase+"/"),null!=this.options.apiPath&&(t+=this.options.apiPath+"/"),t},t.prototype.getServerPath=function(){return this.getApiPath()+this.getUserPath()},t.prototype.getOAuthPath=function(t){var e;return null==(e=this.options.oAuthPaths[t])&&(e="/auth/"+t),e},t.prototype.getOAuthUrl=function(t,e,o){var n;return n=this.options.oAuthBase+"/"+t,n+="?omniauth_window_type="+o,n+="&auth_origin_url="+encodeURIComponent(e),null!=this.userType.value&&(n+="&resource_class="+this.userType.value.name),n},t.prototype.tryLoadAuthData=function(){var t=this.getUserTypeByName(this.localStorage.getItem("userType"));t&&this.userType.next(t),this.getAuthDataFromStorage(),this.activatedRoute&&this.getAuthDataFromParams(),this.authData&&this.validateToken()},t.prototype.getAuthHeadersFromResponse=function(t){var e=t.headers,o={accessToken:e.get("access-token"),client:e.get("client"),expiry:e.get("expiry"),tokenType:e.get("token-type"),uid:e.get("uid")};this.setAuthData(o)},t.prototype.getAuthDataFromPostMessage=function(t){var e={accessToken:t.auth_token,client:t.client_id,expiry:t.expiry,tokenType:"Bearer",uid:t.uid};this.setAuthData(e)},t.prototype.getAuthDataFromStorage=function(){var t={accessToken:this.localStorage.getItem("accessToken"),client:this.localStorage.getItem("client"),expiry:this.localStorage.getItem("expiry"),tokenType:this.localStorage.getItem("tokenType"),uid:this.localStorage.getItem("uid")};this.checkAuthData(t)&&this.authData.next(t)},t.prototype.getAuthDataFromParams=function(){var t=this;this.activatedRoute.queryParams.subscribe((function(e){var o={accessToken:e.token||e.auth_token,client:e.client_id,expiry:e.expiry,tokenType:"Bearer",uid:e.uid};t.checkAuthData(o)&&t.authData.next(o)}))},t.prototype.setAuthData=function(t){this.checkAuthData(t)&&(this.authData.next(t),this.localStorage.setItem("accessToken",t.accessToken),this.localStorage.setItem("client",t.client),this.localStorage.setItem("expiry",t.expiry),this.localStorage.setItem("tokenType",t.tokenType),this.localStorage.setItem("uid",t.uid),null!=this.userType.value&&this.localStorage.setItem("userType",this.userType.value.name))},t.prototype.checkAuthData=function(t){return null!=t.accessToken&&null!=t.client&&null!=t.expiry&&null!=t.tokenType&&null!=t.uid&&(null==this.authData.value||t.expiry>=this.authData.value.expiry)},t.prototype.requestCredentialsViaPostMessage=function(t){var e=i.interval(500),o=i.fromEvent(this.global,"message").pipe(a.pluck("data"),a.filter(this.oAuthWindowResponseFilter));o.subscribe(this.getAuthDataFromPostMessage.bind(this));var n=e.subscribe((function(){t.closed?n.unsubscribe():t.postMessage("requestCredentials","*")}));return o},t.prototype.oAuthWindowResponseFilter=function(t){if("deliverCredentials"===t.message||"authFailure"===t.message)return t},t.prototype.getUserTypeByName=function(t){return null==t||null==this.options.userTypes?null:this.options.userTypes.find((function(e){return e.name===t}))},t.ctorParameters=function(){return[{type:n.HttpClient},{type:void 0,decorators:[{type:e.Inject,args:[p]}]},{type:Object,decorators:[{type:e.Inject,args:[e.PLATFORM_ID]}]},{type:o.ActivatedRoute,decorators:[{type:e.Optional}]},{type:o.Router,decorators:[{type:e.Optional}]}]},t.ɵprov=e.ɵɵdefineInjectable({factory:function(){return new t(e.ɵɵinject(n.HttpClient),e.ɵɵinject(p),e.ɵɵinject(e.PLATFORM_ID),e.ɵɵinject(o.ActivatedRoute,8),e.ɵɵinject(o.Router,8))},token:t,providedIn:"root"}),t=s([e.Injectable({providedIn:"root"}),u(1,e.Inject(p)),u(2,e.Inject(e.PLATFORM_ID)),u(3,e.Optional()),u(4,e.Optional()),l("design:paramtypes",[n.HttpClient,Object,Object,o.ActivatedRoute,o.Router])],t)}(),h=function(){function t(t){this.tokenService=t}return t.prototype.intercept=function(t,e){var o=this;this.tokenService.getAuthDataFromStorage();var n=this.tokenService.authData.value;if(n&&(null===this.tokenService.tokenOptions.apiBase||t.url.match(this.tokenService.tokenOptions.apiBase))){var r={"access-token":n.accessToken,client:n.client,expiry:n.expiry,"token-type":n.tokenType,uid:n.uid};t=t.clone({setHeaders:r})}return e.handle(t).pipe(a.tap((function(t){return o.handleResponse(t)}),(function(t){return o.handleResponse(t)})))},t.prototype.handleResponse=function(t){(t instanceof n.HttpResponse||t instanceof n.HttpErrorResponse)&&(null===this.tokenService.tokenOptions.apiBase||t.url&&t.url.match(this.tokenService.tokenOptions.apiBase))&&this.tokenService.getAuthHeadersFromResponse(t)},t.ctorParameters=function(){return[{type:c}]},t=s([e.Injectable(),l("design:paramtypes",[c])],t)}(),d=function(){function t(t){if(t)throw new Error("AngularToken is already loaded. It should only be imported in your application's main module.")}var o;return o=t,t.forRoot=function(t){return{ngModule:o,providers:[{provide:n.HTTP_INTERCEPTORS,useClass:h,multi:!0},t.angularTokenOptionsProvider||{provide:p,useValue:t}]}},t.ctorParameters=function(){return[{type:t,decorators:[{type:e.Optional},{type:e.SkipSelf}]}]},t=o=s([e.NgModule(),u(0,e.Optional()),u(0,e.SkipSelf()),l("design:paramtypes",[t])],t)}();t.ANGULAR_TOKEN_OPTIONS=p,t.AngularTokenModule=d,t.AngularTokenService=c,t.ɵa=c,t.ɵb=h,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=angular-token.umd.min.js.map